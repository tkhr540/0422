<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0044cc">
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js").then(() => {
        console.log("âœ… Service Worker registered");
      });
    });
  }
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>0422ch ãªã‚“ã§ã‚‚ã‚¢ãƒªãƒ»åŒ¿åã®è‡ªç”±</title>
<meta name="google-site-verification" content="NJ3ZzSV5BrGqR09JvoydRajkW1h82XD_W5vvrSn8s7o" />

<style>
  /* ç®¡ç†è€…ã‚«ãƒ©ãƒ¼ */
.admin-blue   { color:#007bff !important; font-weight:bold; }
.admin-red    { color:#e40000 !important; font-weight:bold; }
.admin-green  { color:#1b9e31 !important; font-weight:bold; }
.admin-yellow { color:#d8b400 !important; font-weight:bold; }

/* ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼æ–‡å­— */
.admin-rainbow {
  font-weight:bold;
  background: linear-gradient(90deg, red, orange, yellow, green, blue, purple);
  -webkit-background-clip: text;
  color: transparent;
}

:root{ --max-width:900px; --accent:#0044cc; --admin:#ffb300; --muted:#666; }
body { font-family:"MS PGothic",Arial,sans-serif; background:#eef2f5; margin:0; padding:12px; color:#222; }
#board { max-width:var(--max-width); margin:0 auto; background:#fff; border:1px solid #ccc; padding:14px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,0.03); }

h1 { text-align:center; border-bottom:2px solid #ddd; padding-bottom:8px; margin:0 0 12px 0; }
h1 img { max-width:260px; width:100%; height:auto; }

#adminLink { position:absolute; top:12px; right:14px; font-size:14px; color:#0077cc; cursor:pointer; display:inline-block; }
#adminLink:hover { text-decoration:underline; }

#adminPanel { display:none; background:linear-gradient(90deg,#ffd54a,#ffc107); border:1px solid #b37b00; padding:8px; margin-bottom:10px; text-align:center; font-weight:bold; }
#adminPanel button { margin-left:8px; padding:4px 8px; }

.thread { border-top:1px solid #e0e0e0; padding:10px; display:flex; justify-content:space-between; align-items:center; }
.thread:first-child { border-top:none; }
.thread.admin-thread { background:linear-gradient(90deg,#fff3cd,#ffecb3); border-left:4px solid #ffb300; padding-left:8px; }
.thread.pinned { background:#f4faff; border-left:4px solid #0044cc; }

.title { font-weight:bold; color:var(--accent); font-size:15px; cursor:pointer; }
.small { font-size:12px; color:var(--muted); }

#posts { max-height:60vh; overflow:auto; margin-top:8px; padding-right:6px; }
.post {
  border-bottom: 1px dotted #ddd;
  padding: 4px 4px;              /* â† ã•ã‚‰ã«å°ã•ã */
  white-space: pre-wrap;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  font-size: 12px;               /* â† æ–‡å­—å°ã•ã */
  line-height: 1.2;              /* â† é«˜ã•ã¤ã‚ã‚‹ */
}

.post .adminName { color:#d00; font-weight:bold; }

.notice { background:#fff8e1; border-left:4px solid var(--admin); padding:10px; font-size:13px; margin:8px 0; color:#333; }

input, textarea { width:100%; box-sizing:border-box; padding:8px; margin:6px 0; font-family:inherit; font-size:14px; border:1px solid #ccc; border-radius:4px; }
button { cursor:pointer; background:#fff; border:1px solid #ccc; border-radius:4px; }
button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.smallBtn { font-size:12px; padding:3px 6px; margin-left:6px; }

@media (max-width:640px){
  :root{--max-width:100%;}
  #board{padding:10px;}
  h1{font-size:18px;}
  h1 img{max-width:200px;}
}
</style>
</head>
<body>
<div id="board">
  <span id="adminLink">ğŸ‘‘ ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</span>
  <h1><img src="logo.png" alt="0422chãƒ­ã‚´"></h1>

  <div id="adminPanel">
    ğŸ‘‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ä¸­
    <button id="adminLogoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <button id="purgeBtn">å¤ã„ã‚¹ãƒ¬ä¸€æ‹¬å‰Šé™¤</button>
  </div>

  <!-- ã‚¹ãƒ¬ä¸€è¦§ -->
  <div id="threadList">
    <h3>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h3>
    <div id="threads">èª­ã¿è¾¼ã¿ä¸­...</div>

    <h3>æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</h3>
    <input id="newName" placeholder="åå‰ï¼ˆç©ºæ¬„â†’åç„¡ã—ã•ã‚“ï¼‰">
    <input id="newTitle" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«">
    <textarea id="newMessage" rows="4" placeholder="æœ¬æ–‡"></textarea>
    <input id="newPass" type="password" placeholder="ã‚¹ãƒ¬å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">


    <div id="adminOptions" style="display:none;">
      <label><input type="checkbox" id="newAnnouncement"> ğŸ“¢å‘ŠçŸ¥</label>
      <label style="margin-left:10px;"><input type="checkbox" id="newPinned"> ğŸ“Œå›ºå®š</label>
    </div>

    <button id="createBtn" class="primary">ã‚¹ãƒ¬ç«‹ã¦</button>
  </div>

  <!-- ã‚¹ãƒ¬è©³ç´° -->
  <div id="threadView" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button id="backBtn">â† æˆ»ã‚‹</button>
      <div id="threadCount" class="small"></div>
    </div>
    <h3 id="threadTitle"></h3>
    <div id="threadMeta" class="small"></div>

    <div class="notice">
      ğŸ’¬ ã“ã®ã‚¹ãƒ¬ã§ã¯å¤ã„è¿”ä¿¡ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ï¼ˆæœ€å¤§50ä»¶ã¾ã§ä¿æŒï¼‰
    </div>

    <div id="posts"></div>

    <div style="margin-top:8px;">
      <!-- ç®¡ç†è€…ã‚«ãƒ©ãƒ¼è¨­å®š -->
<div id="adminColorWrap" style="display:none; margin:6px 0;">
  ğŸ¨ <b>ç®¡ç†è€…ã‚«ãƒ©ãƒ¼ï¼š</b>
  <select id="adminColor">
    <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
    <option value="blue">é’</option>
    <option value="red">èµ¤</option>
    <option value="green">ç·‘</option>
    <option value="yellow">é»„è‰²</option>
    <option value="rainbow">ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼</option>
  </select>
</div>

      <input id="replyName" placeholder="åå‰ï¼ˆç©ºæ¬„â†’åç„¡ã—ã•ã‚“ï¼‰">
      <textarea id="replyMsg" rows="3" placeholder="è¿”ä¿¡å†…å®¹"></textarea>
      <button id="replyBtn" class="primary">è¿”ä¿¡</button>
    </div>
  </div>
</div>

<!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="adminModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:18px; border-radius:8px; width:320px;">
    <h3>ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <input type="email" id="adminEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">

    <div style="text-align:right;margin-top:8px;">
      <button id="adminLoginBtn" class="primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="adminCancelBtn">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<!-- FireBase & ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, set, get, onValue, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

/* ===== Firebase è¨­å®š ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDvxu40-FMk2RcFRk-GQgismwE0H0vSeQM",
  authDomain: "ch-7d7a0.firebaseapp.com",
  databaseURL: "https://ch-7d7a0-default-rtdb.firebaseio.com",
  projectId: "ch-7d7a0",
  storageBucket: "ch-7d7a0.firebasestorage.app",
  messagingSenderId: "13647387226",
  appId: "1:13647387226:web:dbadf4d6e5356a85c25663",
  measurementId: "G-VTXPF0SPVD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const threadsRef = ref(db, "threads");

const MAX_REPLIES = 50;
let isAdmin = false;
let currentThreadId = null;


/* ===== ã‚¹ãƒ¬ä¸€è¦§èª­ã¿è¾¼ã¿ ===== */
onValue(threadsRef, snap => {
  const data = snap.val() || {};
  const arr = Object.entries(data).map(([id,t])=>({id,...t}));

  arr.sort((a,b)=>{
    const pa=a.pinned?1:0,pb=b.pinned?1:0;
    if(pa!==pb) return pb-pa;
    return b.createdAt-a.createdAt;
  });

  const div=document.getElementById("threads");
  div.innerHTML="";

  arr.forEach(t=>{
    const replyCount=t.posts?Object.keys(t.posts).length:0;
    const el=document.createElement("div");

    el.className="thread"+
      (t.createdByAdmin?" admin-thread":"")+
      (t.pinned?" pinned":"");

    el.innerHTML=`
  <div>
    <div class='title'>${t.announcement?"ğŸ“¢ ":""}${escapeHtml(t.title)}</div>
    <div class='small'>${fmt(t.createdAt)} / è¿”ä¿¡${replyCount}ä»¶</div>
  </div>
  <div>
    <button class="smallBtn" onclick="openThread('${t.id}')">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã</button>
    <button class='smallBtn' onclick="deleteThread('${t.id}')">å‰Šé™¤</button>
  </div>
`;


    div.appendChild(el);
  });
});
  /* ===== æˆ»ã‚‹ãƒœã‚¿ãƒ³ ===== */
backBtn.onclick = () => {
  // ã‚¹ãƒ¬è¡¨ç¤ºã‚’æ¶ˆã—ã¦ä¸€è¦§ã«æˆ»ã™
  document.getElementById("threadView").style.display = "none";
  document.getElementById("threadList").style.display = "block";

  // æŠ•ç¨¿ã®ç›£è¦–ã‚’æ­¢ã‚ã‚‹ï¼ˆé‡è¤‡èª­ã¿è¾¼ã¿é˜²æ­¢ï¼‰
  currentThreadId = null;
};



/* ===== ã‚¹ãƒ¬ã‚’é–‹ã ===== */
window.openThread = id => {
  currentThreadId = id;

  document.getElementById("threadList").style.display="none";
  document.getElementById("threadView").style.display="block";

  const postsRef = child(threadsRef, `${id}/posts`);

  onValue(postsRef, snap => {
    const postsDiv=document.getElementById("posts");

    // â–¼ ç¾åœ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒä¸‹ä»˜è¿‘ã‹ç¢ºèª
    const shouldScroll =
      postsDiv.scrollTop + postsDiv.clientHeight >= postsDiv.scrollHeight - 50;

    postsDiv.innerHTML="";

    const val=snap.val()||{};
    let items=Object.entries(val).map(([k,v])=>({key:k,v}));

    items.sort((a,b)=>(a.v.createdAt||0)-(b.v.createdAt||0));

    // è¿”ä¿¡50ä»¶è¶… â†’ å¤ã„é †ã«å‰Šé™¤
    if(items.length > MAX_REPLIES){
      const removeCount = items.length - MAX_REPLIES;
      const oldItems = items.slice(0, removeCount);
      oldItems.forEach(o=>{
        remove(ref(db, `threads/${id}/posts/${o.key}`));
      });
      items = items.slice(removeCount);
    }

    items.forEach((item, idx) => {
      const p=item.v;

      const div=document.createElement("div");
      div.className="post";

      div.innerHTML=`
        <div>
          <b>${idx+1}:</b>
         <span class="
  ${p.admin ? "adminName" : ""}
  ${p.color ? "admin-" + p.color : ""}
">${escapeHtml(p.name)}</span>

${p.admin ? "<span class='small'>â—†ç®¡ç†äºº</span>" : ""}

          <br>${escapeHtml(p.msg||p.message)}
          <div class="small">${p.time}</div>
        </div>
        ${isAdmin ? `<button class="smallBtn" onclick="deleteReply('${item.key}')">å‰Šé™¤</button>` : ""}
      `;

      postsDiv.appendChild(div);
    });

    if(shouldScroll){
      postsDiv.scrollTop = postsDiv.scrollHeight;
    }
  });
};


/* ===== è¿”ä¿¡é€ä¿¡ ===== */
replyBtn.onclick = () => {
  const m = replyMsg.value.trim();
  if(!m)return;

  const n = replyName.value.trim() || "åç„¡ã—ã•ã‚“";
  const ts = new Date().toLocaleString("ja-JP");

  const postRef = ref(db, `threads/${currentThreadId}/posts`);
  push(postRef,{
    name:n,
    msg:m,
    time:ts,
    createdAt:Date.now(),
    admin: isAdmin || null,
color: isAdmin ? adminColor.value : null

  });

  replyMsg.value="";
};


/* ===== ã‚¹ãƒ¬å‰Šé™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œï¼‰ ===== */
window.deleteThread = async (id) => {

  // ç®¡ç†è€…ã¯å³å‰Šé™¤
  if (isAdmin) {
    if (confirm("ç®¡ç†è€…ã¨ã—ã¦ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      remove(ref(db, `threads/${id}`));
      threadView.style.display = "none";
      threadList.style.display = "block";
    }
    return;
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—
  const snap = await get(ref(db, `threads/${id}/threadPass`));
  const threadPass = snap.val();

  if (!threadPass) {
    alert("ã“ã®ã‚¹ãƒ¬ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
    return;
  }

  const input = prompt("ã‚¹ãƒ¬å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");

  if (input === threadPass) {
    alert("ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    remove(ref(db, `threads/${id}`));
    threadView.style.display = "none";
    threadList.style.display = "block";
  } else {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
  }
};


/* ===== è¿”ä¿¡å‰Šé™¤ ===== */
window.deleteReply = key => {
  if(!confirm("ã“ã®è¿”ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
  remove(ref(db, `threads/${currentThreadId}/posts/${key}`));
};


/* ===== ã‚¹ãƒ¬ç«‹ã¦ ===== */
createBtn.onclick=()=>{
  const name=newName.value.trim()||"åç„¡ã—ã•ã‚“";
  const title=newTitle.value.trim();
  const msg=newMessage.value.trim();
  if(!title||!msg)return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const ts=new Date().toLocaleString("ja-JP");
  const tRef=push(threadsRef);

  set(tRef,{
    title,
    createdAt: Date.now(),
    threadPass: newPass.value || null,  // â† è¿½åŠ 
    announcement:isAdmin&&newAnnouncement.checked?true:null,
    pinned:isAdmin&&newPinned.checked?true:null,
    createdByAdmin:isAdmin?true:null
});


  const p=ref(db, `threads/${tRef.key}/posts`);
  push(p,{
    name,
    msg,
    time:ts,
    createdAt:Date.now(),
    admin:isAdmin||null
  });

  newMessage.value="";
  newTitle.value="";
};


/* ===== ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³ ===== */
adminLink.onclick=()=>adminModal.style.display="flex";
adminCancelBtn.onclick=()=>adminModal.style.display="none";

adminLoginBtn.onclick=async()=>{
  const email=adminEmail.value;
  const pass=adminPass.value;

  try{
    await signInWithEmailAndPassword(auth,email,pass);
    alert("ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ");
    adminModal.style.display="none";
  }catch(e){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
};

adminLogoutBtn.onclick=async()=>{
  await signOut(auth);
  alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
};


/* ===== ç®¡ç†çŠ¶æ…‹ã®åæ˜  ===== */
onAuthStateChanged(auth,user=>{
  isAdmin=!!user;
  adminPanel.style.display=isAdmin?"block":"none";
  adminLink.style.display=isAdmin?"none":"inline-block";
  document.getElementById("adminOptions").style.display=isAdmin?"block":"none";
document.getElementById("adminColorWrap").style.display = isAdmin ? "block" : "none";
});


/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>{
    return {"&":"&amp;","<":"&lt;","\">":"&gt;","\"":"&quot;","'":"&#39;"}[m];
  });
}
function fmt(t){
  return new Date(t).toLocaleString();
}
</script>

</body>
</html>
